machine:
  java:
    version:
      oraclejdk8

dependencies:
 override: 
  - mvn --fail-never dependency:go-offline || true

test:
 post:
  - mkdir -p $CIRCLE_TEST_REPORTS/junit/
  - find . -type f -regex ".*/target/.*-reports/.*xml" -exec cp {} $CIRCLE_TEST_REPORTS/junit/ \;


# Using this means that it'll only deploy to artifactory if a release tag is pushed
deployment:
 release:
   tag: /release-.*/
   commands:
   - gpg --passphrase $GPG_KEYFILE_ENCRYPT_PASSPHRASE --decrypt src/config/gpg-keys.encrypted --output gpg.keyring
   - mvn -X -s build_server_maven_settings.xml -Dgpg.passphrase=$GPG_PASSPHRASE -Dgpg.keyname=$GPG_KEYNAME -Dgpg.publicKeyring=$HOME/src/config/ci-keyring.asc -Dgpg.secretKeyring=$HOME/src/config/ci-keyring.asc  -DskipTests javadoc:jar source:jar deploy
   - rm gpg.keyring